name: Build ExecuTorch Flutter Plugin

on:
  push:
    branches: [ main, develop, 007-ffi-build-system ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Cancel in-progress runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==============================================================================
  # Analyze Dart Code
  # ==============================================================================
  analyze:
    name: Analyze Dart Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze code
        run: flutter analyze

      - name: Run dart fix (dry run)
        run: dart fix --dry-run

  # ==============================================================================
  # Build Android
  # ==============================================================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: analyze

    strategy:
      matrix:
        abi: [arm64-v8a, x86_64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Setup Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Android plugin (${{ matrix.abi }})
        working-directory: example
        env:
          ANDROID_ABI_FILTER: ${{ matrix.abi }}
        run: flutter build apk --debug --target-platform android-${{ matrix.abi == 'arm64-v8a' && 'arm64' || 'x64' }}

      - name: Check native library exists
        run: |
          if [ "${{ matrix.abi }}" == "arm64-v8a" ]; then
            ARCH_DIR="arm64-v8a"
          else
            ARCH_DIR="x86_64"
          fi

          LIB_PATH="example/build/app/intermediates/cmake/debug/obj/$ARCH_DIR/libexecutorch_flutter_wrapper.so"

          if [ ! -f "$LIB_PATH" ]; then
            echo "❌ ERROR: Native library not found at $LIB_PATH"
            exit 1
          fi

          echo "✅ Native library found: $LIB_PATH"
          ls -lh "$LIB_PATH"

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-build
          path: |
            example/build/app/intermediates/cmake/debug/obj/${{ matrix.abi }}/libexecutorch_flutter_wrapper.so
          retention-days: 7

  # ==============================================================================
  # Build iOS
  # ==============================================================================
  build-ios:
    name: Build iOS
    runs-on: macos-14  # Apple Silicon runner
    timeout-minutes: 60
    needs: analyze

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Setup CocoaPods cache
        uses: actions/cache@v4
        with:
          path: |
            example/ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles('example/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Setup Swift Package Manager cache
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            example/ios/.build
          key: ${{ runner.os }}-spm-ios-${{ hashFiles('ios/executorch_flutter/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-ios-

      - name: Build iOS framework
        working-directory: example
        run: flutter build ios --debug --no-codesign

      - name: Check framework exists
        run: |
          FRAMEWORK_PATH="example/build/ios/Debug-iphoneos/executorch_flutter.framework"

          if [ ! -d "$FRAMEWORK_PATH" ]; then
            echo "❌ ERROR: Framework not found at $FRAMEWORK_PATH"
            exit 1
          fi

          echo "✅ Framework found: $FRAMEWORK_PATH"
          ls -lh "$FRAMEWORK_PATH"

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            example/build/ios/Debug-iphoneos/executorch_flutter.framework
          retention-days: 7

  # ==============================================================================
  # Build macOS
  # ==============================================================================
  build-macos:
    name: Build macOS
    runs-on: macos-14  # Apple Silicon runner
    timeout-minutes: 60
    needs: analyze

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Setup Swift Package Manager cache
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            example/macos/.build
          key: ${{ runner.os }}-spm-macos-${{ hashFiles('macos/executorch_flutter/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-macos-

      - name: Build macOS app (Debug)
        working-directory: example
        run: flutter build macos --debug

      - name: Check framework exists
        run: |
          FRAMEWORK_PATH="example/build/macos/Build/Products/Debug/executorch_flutter.framework"

          if [ ! -d "$FRAMEWORK_PATH" ]; then
            echo "❌ ERROR: Framework not found at $FRAMEWORK_PATH"
            exit 1
          fi

          echo "✅ Framework found: $FRAMEWORK_PATH"
          ls -lh "$FRAMEWORK_PATH"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            example/build/macos/Build/Products/Debug/executorch_flutter.framework
          retention-days: 7

  # ==============================================================================
  # Summary
  # ==============================================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, build-macos]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-android.result }}" == "success" ]; then
            echo "| Android | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Android | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "| iOS | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| iOS | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-macos.result }}" == "success" ]; then
            echo "| macOS | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| macOS | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Overall build status
        if: |
          needs.build-android.result != 'success' ||
          needs.build-ios.result != 'success' ||
          needs.build-macos.result != 'success'
        run: |
          echo "❌ One or more builds failed"
          exit 1
